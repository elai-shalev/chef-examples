# Redis configuration file
# Generated by Ansible

# General
daemonize yes
pidfile /var/run/redis/{{ item.port }}.pid
port {{ item.port }}
tcp-backlog {{ item.tcp_backlog | default(511) }}
{% if item.socket is defined %}
unixsocket {{ item.socket }}
unixsocketperm {{ item.socket_perm | default(755) }}
{% endif %}
timeout {{ item.timeout | default(0) }}
tcp-keepalive {{ item.tcp_keepalive | default(0) }}

# Snapshotting
{% if item.save is defined %}
{% for save_rule in item.save %}
save {{ save_rule }}
{% endfor %}
{% else %}
save 900 1
save 300 10
save 60 10000
{% endif %}
stop-writes-on-bgsave-error {{ item.stop_writes_on_bgsave_error | default('yes') }}
rdbcompression {{ item.rdbcompression | default('yes') }}
rdbchecksum {{ item.rdbchecksum | default('yes') }}
dbfilename {{ item.dbfilename | default('dump.rdb') }}
dir {{ redis_data_dir | default('/var/lib/redis') }}/{{ item.port }}

# Replication
{% if item.slaveof is defined %}
slaveof {{ item.slaveof.address }} {{ item.slaveof.port }}
{% endif %}
{% if item.masterauth is defined %}
masterauth {{ item.masterauth }}
{% endif %}
slave-serve-stale-data {{ item.slave_serve_stale_data | default('yes') }}
slave-read-only {{ item.slave_read_only | default('yes') }}
repl-diskless-sync {{ item.repl_diskless_sync | default('no') }}
repl-diskless-sync-delay {{ item.repl_diskless_sync_delay | default(5) }}
repl-ping-slave-period {{ item.repl_ping_slave_period | default(10) }}
repl-timeout {{ item.repl_timeout | default(60) }}
repl-disable-tcp-nodelay {{ item.repl_disable_tcp_nodelay | default('no') }}
repl-backlog-size {{ item.repl_backlog_size | default('1mb') }}
repl-backlog-ttl {{ item.repl_backlog_ttl | default(3600) }}
slave-priority {{ item.slave_priority | default(100) }}
{% if item.min_slaves_to_write is defined %}
min-slaves-to-write {{ item.min_slaves_to_write }}
{% endif %}
{% if item.min_slaves_max_lag is defined %}
min-slaves-max-lag {{ item.min_slaves_max_lag }}
{% endif %}

# Security
{% if item.requirepass is defined %}
requirepass {{ item.requirepass }}
{% endif %}
{% if item.rename_commands is defined %}
{% for command, newname in item.rename_commands.items() %}
rename-command {{ command }} {{ newname }}
{% endfor %}
{% endif %}

# Limits
maxclients {{ item.maxclients | default(10000) }}
{% if item.maxmemory is defined %}
maxmemory {{ item.maxmemory }}
maxmemory-policy {{ item.maxmemory_policy | default('volatile-lru') }}
maxmemory-samples {{ item.maxmemory_samples | default(3) }}
{% endif %}

# Append Only Mode
appendonly {{ item.appendonly | default('no') }}
appendfilename {{ item.appendfilename | default('appendonly.aof') }}
appendfsync {{ item.appendfsync | default('everysec') }}
no-appendfsync-on-rewrite {{ item.no_appendfsync_on_rewrite | default('no') }}
auto-aof-rewrite-percentage {{ item.auto_aof_rewrite_percentage | default(100) }}
auto-aof-rewrite-min-size {{ item.auto_aof_rewrite_min_size | default('64mb') }}
aof-load-truncated {{ item.aof_load_truncated | default('yes') }}

# Lua Scripting
lua-time-limit {{ item.lua_time_limit | default(5000) }}

# Slow Log
slowlog-log-slower-than {{ item.slowlog_log_slower_than | default(10000) }}
slowlog-max-len {{ item.slowlog_max_len | default(128) }}

# Latency Monitor
latency-monitor-threshold {{ item.latency_monitor_threshold | default(0) }}

# Event Notification
notify-keyspace-events {{ item.notify_keyspace_events | default('""') }}

# Advanced Config
hash-max-ziplist-entries {{ item.hash_max_ziplist_entries | default(512) }}
hash-max-ziplist-value {{ item.hash_max_ziplist_value | default(64) }}
list-max-ziplist-entries {{ item.list_max_ziplist_entries | default(512) }}
list-max-ziplist-value {{ item.list_max_ziplist_value | default(64) }}
set-max-intset-entries {{ item.set_max_intset_entries | default(512) }}
zset-max-ziplist-entries {{ item.zset_max_ziplist_entries | default(128) }}
zset-max-ziplist-value {{ item.zset_max_ziplist_value | default(64) }}
hll-sparse-max-bytes {{ item.hll_sparse_max_bytes | default(3000) }}
activerehashing {{ item.activerehashing | default('yes') }}
client-output-buffer-limit normal {{ item.client_output_buffer_limit_normal | default('0 0 0') }}
client-output-buffer-limit slave {{ item.client_output_buffer_limit_slave | default('256mb 64mb 60') }}
client-output-buffer-limit pubsub {{ item.client_output_buffer_limit_pubsub | default('32mb 8mb 60') }}
hz {{ item.hz | default(10) }}
aof-rewrite-incremental-fsync {{ item.aof_rewrite_incremental_fsync | default('yes') }}

# Include additional configuration files
{% if item.includes is defined %}
{% for include in item.includes %}
include {{ include }}
{% endfor %}
{% endif %}

# Custom configuration
{% if item.custom_config is defined %}
{% for config in item.custom_config %}
{{ config }}
{% endfor %}
{% endif %}